{% extends "base.html" %}

{% block title %}ä¼æ¥­ç®¡ç† - HUGANJOBå–¶æ¥­ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
.management-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.tab-container {
    margin-bottom: 30px;
}

.nav-tabs {
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 20px;
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #6c757d;
    font-weight: 500;
    padding: 12px 24px;
}

.nav-tabs .nav-link.active {
    color: #007bff;
    border-bottom-color: #007bff;
    background-color: transparent;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #007bff;
    color: #007bff;
}

.tab-content {
    padding: 20px 0;
}

.form-container {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    font-weight: bold;
    margin-bottom: 8px;
    display: block;
    color: #495057;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.15s ease-in-out;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
    transform: translateY(-1px);
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    margin-left: 10px;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.upload-icon {
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 16px;
}

.upload-text {
    font-size: 18px;
    color: #495057;
    margin-bottom: 8px;
}

.upload-subtext {
    font-size: 14px;
    color: #6c757d;
}

.file-info {
    background-color: #e9ecef;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
}

.preview-table {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
}

.alert {
    padding: 12px 16px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 6px;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.feature-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.feature-icon {
    font-size: 24px;
    color: #007bff;
    margin-bottom: 10px;
}

.feature-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #495057;
}

.feature-description {
    color: #6c757d;
    font-size: 14px;
    line-height: 1.5;
}
</style>
{% endblock %}

{% block content %}
<div class="management-container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-building me-2"></i>ä¼æ¥­ç®¡ç†
                <small class="text-muted">- ä¼æ¥­è¿½åŠ ãƒ»CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</small>
            </h1>
        </div>
    </div>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tab-container">
        <ul class="nav nav-tabs" id="managementTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="single-add-tab" data-bs-toggle="tab" data-bs-target="#single-add" type="button" role="tab">
                    <i class="fas fa-plus me-2"></i>å˜ä½“ä¼æ¥­è¿½åŠ 
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="csv-import-tab" data-bs-toggle="tab" data-bs-target="#csv-import" type="button" role="tab">
                    <i class="fas fa-file-csv me-2"></i>CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
            </li>
        </ul>
    </div>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content" id="managementTabContent">
        <!-- å˜ä½“ä¼æ¥­è¿½åŠ ã‚¿ãƒ– -->
        <div class="tab-pane fade show active" id="single-add" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-container">
                        <h3 class="mb-4">
                            <i class="fas fa-building me-2"></i>æ–°è¦ä¼æ¥­æƒ…å ±è¿½åŠ 
                        </h3>
                        
                        <form id="addCompanyForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="companyName" class="form-label">ä¼æ¥­å <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="companyName" name="company_name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="companyUrl" class="form-label">ä¼æ¥­ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ <span class="text-danger">*</span></label>
                                        <input type="url" class="form-control" id="companyUrl" name="company_url" placeholder="https://example.com" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="emailAddress" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                        <input type="email" class="form-control" id="emailAddress" name="email_address" placeholder="info@example.com">
                                        <small class="form-text text-muted">ç©ºæ¬„ã®å ´åˆã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰è‡ªå‹•æŠ½å‡ºã‚’è©¦è¡Œã—ã¾ã™</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="jobPosition" class="form-label">å‹Ÿé›†è·ç¨®</label>
                                        <input type="text" class="form-control" id="jobPosition" name="job_position" placeholder="ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€å–¶æ¥­ãªã©">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>ä¼æ¥­ã‚’è¿½åŠ 
                                </button>
                                <button type="reset" class="btn btn-secondary">
                                    <i class="fas fa-undo me-2"></i>ãƒªã‚»ãƒƒãƒˆ
                                </button>
                            </div>
                        </form>
                        
                        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div id="addResult" class="mt-4"></div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="feature-title">å˜ä½“è¿½åŠ ã«ã¤ã„ã¦</div>
                        <div class="feature-description">
                            ä¼æ¥­æƒ…å ±ã‚’1ç¤¾ãšã¤æ‰‹å‹•ã§è¿½åŠ ã§ãã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸æ˜ãªå ´åˆã¯ã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰è‡ªå‹•æŠ½å‡ºã‚’è©¦è¡Œã—ã¾ã™ã€‚
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="feature-title">é‡è¤‡ãƒã‚§ãƒƒã‚¯</div>
                        <div class="feature-description">
                            ä¼æ¥­ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ä¼æ¥­åã«ã‚ˆã‚‹é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è‡ªå‹•å®Ÿè¡Œã—ã€æ—¢å­˜ä¼æ¥­ã¨ã®é‡è¤‡ã‚’é˜²æ­¢ã—ã¾ã™ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
        <div class="tab-pane fade" id="csv-import" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="form-container">
                        <h3 class="mb-4">
                            <i class="fas fa-file-csv me-2"></i>CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </h3>
                        
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="upload-subtext">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        </div>
                        
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º -->
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <h5>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h5>
                            <p id="fileName"></p>
                            <p id="fileSize"></p>
                        </div>
                        
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
                        <div id="previewArea" style="display: none;">
                            <h5 class="mt-4">ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                            <div class="preview-table">
                                <table class="table table-striped" id="previewTable">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary" id="confirmImport">
                                    <i class="fas fa-check me-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancelImport">
                                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                            </div>
                        </div>
                        
                        <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                            </div>
                            <p class="mt-2">å‡¦ç†ä¸­ã§ã™...</p>
                        </div>
                        
                        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div id="importResult" class="mt-4"></div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="feature-title">CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</div>
                        <div class="feature-description">
                            å¿…é ˆåˆ—: ä¼æ¥­å, ä¼æ¥­ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸<br>
                            ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹, å‹Ÿé›†è·ç¨®<br>
                            ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒå¿…è¦ã§ã™ã€‚
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="feature-title">è‡ªå‹•å‡¦ç†æ©Ÿèƒ½</div>
                        <div class="feature-description">
                            é‡è¤‡ãƒã‚§ãƒƒã‚¯ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è‡ªå‹•æŠ½å‡ºã€ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// å˜ä½“ä¼æ¥­è¿½åŠ æ©Ÿèƒ½
document.getElementById('addCompanyForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {
        company_name: formData.get('company_name'),
        company_url: formData.get('company_url'),
        email_address: formData.get('email_address'),
        job_position: formData.get('job_position')
    };

    // çµæœã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
    const resultDiv = document.getElementById('addResult');
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>ä¼æ¥­æƒ…å ±ã‚’è¿½åŠ ä¸­...</div>';

    fetch('/api/add-company', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>ä¼æ¥­è¿½åŠ å®Œäº†</strong><br>
                    ä¼æ¥­å: ${data.company_name}<br>
                    ä¼æ¥­ID: ${data.company_id}<br>
                    ${data.email_extracted ? 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è‡ªå‹•æŠ½å‡º: ' + data.email_address : ''}
                    ${data.duplicate_handled ? '<br><span class="text-warning">é‡è¤‡ä¼æ¥­ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã—ãŸ</span>' : ''}
                </div>
            `;
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            this.reset();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>ã‚¨ãƒ©ãƒ¼</strong><br>
                    ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>é€šä¿¡ã‚¨ãƒ©ãƒ¼</strong><br>
                ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
            </div>
        `;
    });
});

// CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
const uploadArea = document.getElementById('uploadArea');
const csvFileInput = document.getElementById('csvFileInput');
const fileInfo = document.getElementById('fileInfo');
const previewArea = document.getElementById('previewArea');
const loadingSpinner = document.getElementById('loadingSpinner');
const importResult = document.getElementById('importResult');

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
uploadArea.addEventListener('click', () => {
    csvFileInput.click();
});

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
csvFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFileSelect(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'danger');
        return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
    document.getElementById('fileName').textContent = `ãƒ•ã‚¡ã‚¤ãƒ«å: ${file.name}`;
    document.getElementById('fileSize').textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024).toFixed(2)} KB`;
    fileInfo.style.display = 'block';

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    uploadFile(file);
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadFile(file) {
    const formData = new FormData();
    formData.append('csv_file', file);

    loadingSpinner.style.display = 'block';
    previewArea.style.display = 'none';
    importResult.innerHTML = '';

    fetch('/api/csv-import', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
    })
    .then(data => {
        loadingSpinner.style.display = 'none';
        console.log('Response data:', data);

        if (data.success) {
            displayPreview(data.preview_data, data.temp_file);
        } else {
            const errorMsg = data.error || 'Unknown error';
            const detailsMsg = data.details ? `\nè©³ç´°: ${data.details}` : '';
            showAlert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${errorMsg}${detailsMsg}`, 'danger');
            console.error('Server error:', data);
        }
    })
    .catch(error => {
        loadingSpinner.style.display = 'none';
        console.error('Fetch error:', error);
        showAlert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
    });
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
function displayPreview(previewData, tempFile) {
    const table = document.getElementById('previewTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');

    // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
    thead.innerHTML = '';
    if (previewData.length > 0) {
        const headerRow = document.createElement('tr');
        Object.keys(previewData[0]).forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
    }

    // ãƒ‡ãƒ¼ã‚¿è¡Œä½œæˆ
    tbody.innerHTML = '';
    previewData.slice(0, 10).forEach(row => { // æœ€åˆã®10è¡Œã®ã¿è¡¨ç¤º
        const tr = document.createElement('tr');
        Object.values(row).forEach(value => {
            const td = document.createElement('td');
            td.textContent = value || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });

    previewArea.style.display = 'block';

    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºå®šãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('confirmImport').onclick = () => confirmImport(tempFile);
    document.getElementById('cancelImport').onclick = cancelImport;
}

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºå®š
function confirmImport(tempFile) {
    loadingSpinner.style.display = 'block';
    previewArea.style.display = 'none';

    fetch('/api/csv-import-confirm', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ temp_file: tempFile })
    })
    .then(response => {
        console.log('Confirm response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
    })
    .then(data => {
        loadingSpinner.style.display = 'none';
        console.log('Confirm response data:', data);

        if (data.success) {
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªã—ã¦ã‹ã‚‰è¡¨ç¤º
            const totalProcessed = data.total_processed || 0;
            const addedCount = data.added || 0;
            const skippedCount = data.skipped || 0;
            const errorCount = data.errors || 0;
            const excludedCount = data.incomplete_excluded || 0;  // ğŸ†• ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿é™¤å¤–æ•°

            let alertClass = 'alert-success';
            if (errorCount > 0) {
                alertClass = errorCount > addedCount ? 'alert-warning' : 'alert-info';
            }

            let detailsHtml = '';
            if (data.details && data.details.length > 0) {
                const errorDetails = data.details.filter(d => d.status === 'error').slice(0, 10); // æœ€åˆã®10ä»¶ã®ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                const excludedDetails = data.details.filter(d => d.status === 'excluded').slice(0, 5); // ğŸ†• é™¤å¤–è©³ç´°

                if (errorDetails.length > 0 || excludedDetails.length > 0) {
                    detailsHtml = `<div class="mt-3">`;

                    if (errorDetails.length > 0) {
                        detailsHtml += `
                            <h6>ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆæœ€åˆã®10ä»¶ï¼‰:</h6>
                            <ul class="list-unstyled">
                                ${errorDetails.map(detail => `
                                    <li class="text-danger small">
                                        è¡Œ${detail.row}: ${detail.company_name || 'ä¸æ˜'} - ${detail.message}
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }

                    if (excludedDetails.length > 0) {
                        detailsHtml += `
                            <h6>é™¤å¤–ã•ã‚ŒãŸä¼æ¥­ï¼ˆæœ€åˆã®5ä»¶ï¼‰:</h6>
                            <ul class="list-unstyled">
                                ${excludedDetails.map(detail => `
                                    <li class="text-info small">
                                        è¡Œ${detail.row}: ${detail.company_name || 'ä¸æ˜'} - ${detail.message}
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }

                    detailsHtml += `</div>`;
                }
            }

            // ğŸ†• é™¤å¤–æ•°ã‚’è¡¨ç¤ºã«è¿½åŠ 
            let excludedHtml = '';
            if (excludedCount > 0) {
                excludedHtml = `<br>ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿é™¤å¤–: ${excludedCount}ä»¶`;
            }

            importResult.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</strong><br>
                    å‡¦ç†æ¸ˆã¿: ${totalProcessed}ä»¶<br>
                    è¿½åŠ æˆåŠŸ: ${addedCount}ä»¶<br>
                    é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶${excludedHtml}<br>
                    ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶
                    ${detailsHtml}
                </div>
            `;

            // ğŸ†• ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸæ™‚ã«ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå³æ™‚åæ˜ ã®ãŸã‚ï¼‰
            if (addedCount > 0) {
                setTimeout(() => {
                    console.log('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ - ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™');
                    window.location.reload();
                }, 2000); // 2ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
            }
        } else {
            const errorMsg = data.error || 'Unknown error';
            const detailsMsg = data.details ? `\nè©³ç´°: ${data.details}` : '';
            showAlert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${errorMsg}${detailsMsg}`, 'danger');
            console.error('Server error:', data);
        }

        // UI ãƒªã‚»ãƒƒãƒˆ
        resetImportUI();
    })
    .catch(error => {
        loadingSpinner.style.display = 'none';
        console.error('Confirm fetch error:', error);
        showAlert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
    });
}

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelImport() {
    resetImportUI();
    showAlert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚', 'info');
}

// UI ãƒªã‚»ãƒƒãƒˆ
function resetImportUI() {
    fileInfo.style.display = 'none';
    previewArea.style.display = 'none';
    csvFileInput.value = '';
}

// ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
function showAlert(message, type) {
    const alertClass = `alert-${type}`;
    const iconClass = type === 'success' ? 'fa-check-circle' :
                     type === 'danger' ? 'fa-exclamation-triangle' :
                     'fa-info-circle';

    importResult.innerHTML = `
        <div class="alert ${alertClass}">
            <i class="fas ${iconClass} me-2"></i>
            ${message}
        </div>
    `;
}
</script>
{% endblock %}
