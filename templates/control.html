<!--
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯åˆ¶å¾¡ãƒ‘ãƒãƒ«æ©Ÿèƒ½ãŒãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«çµ±åˆã•ã‚ŒãŸãŸã‚ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚
åˆ¶å¾¡ãƒ‘ãƒãƒ«æ©Ÿèƒ½ã¯ç¾åœ¨ templates/index.html ã«çµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ¶å¾¡ãƒ‘ãƒãƒ«ï¼ˆå»ƒæ­¢æ¸ˆã¿ï¼‰ | HUGANJOBå–¶æ¥­ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">HUGANJOBå–¶æ¥­ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/control">åˆ¶å¾¡ãƒ‘ãƒãƒ«</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/companies">ä¼æ¥­ä¸€è¦§</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/daily_stats">æ—¥åˆ¥çµ±è¨ˆ</a>
                    </li>


                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
                        <li class="breadcrumb-item active" aria-current="page">åˆ¶å¾¡ãƒ‘ãƒãƒ«</li>
                    </ol>
                </nav>



                <div class="row">
                    <!-- HUGANJOBå–¶æ¥­ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¦‚è¦ã‚«ãƒ¼ãƒ‰ -->
                    <div class="col-12 mb-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-envelope me-2"></i>HUGANJOBæ¡ç”¨å–¶æ¥­ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ 
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 border-info">
                                            <div class="card-body">
                                                <h6 class="card-title text-info">
                                                    <i class="fas fa-search me-1"></i>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ±ºå®š
                                                </h6>
                                                <p class="card-text">CSVãƒ‡ãƒ¼ã‚¿ã¨ã‚¦ã‚§ãƒ–ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ±ºå®š</p>
                                                <div class="small text-muted">
                                                    <div><strong>å¯¾è±¡:</strong> 1,885ç¤¾</div>
                                                    <div><strong>æˆåŠŸç‡:</strong> 18.6%</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 border-warning">
                                            <div class="card-body">
                                                <h6 class="card-title text-warning">
                                                    <i class="fas fa-edit me-1"></i>ãƒ¡ãƒ¼ãƒ«å†…å®¹æº–å‚™
                                                </h6>
                                                <p class="card-text">ä¼æ¥­åãƒ»å‹Ÿé›†è·ç¨®ã‚’å‹•çš„æŒ¿å…¥ã—ãŸHTMLãƒ¡ãƒ¼ãƒ«</p>
                                                <div class="small text-muted">
                                                    <div><strong>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</strong> corporate-email-newsletter.html</div>
                                                    <div><strong>é€ä¿¡è€…:</strong> ç«¹ä¸‹éš¼å¹³ã€æ ªå¼ä¼šç¤¾HUGANã€‘</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 border-success">
                                            <div class="card-body">
                                                <h6 class="card-title text-success">
                                                    <i class="fas fa-paper-plane me-1"></i>ä¸€æ‹¬ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                                                </h6>
                                                <p class="card-text">HUGANJOBæ¡ç”¨å–¶æ¥­ãƒ¡ãƒ¼ãƒ«ã‚’å®‰å…¨ã«ä¸€æ‹¬é€ä¿¡</p>
                                                <div class="small text-muted">
                                                    <div><strong>é€ä¿¡é–“éš”:</strong> 5ç§’</div>
                                                    <div><strong>SMTP:</strong> smtp.huganjob.jp:587</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-danger text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-paper-plane me-2"></i>HUGANJOBæœ¬ç•ªãƒ¡ãƒ¼ãƒ«é€ä¿¡åˆ¶å¾¡
                                </h5>
                                <small>é‡è¤‡é€ä¿¡é˜²æ­¢ãƒ»ãƒã‚¦ãƒ³ã‚¹é™¤å¤–æ©Ÿèƒ½ä»˜ã</small>
                            </div>
                            <div class="card-body">
                                <form id="startProcessForm">
                                    <div class="mb-3">
                                        <label for="commandSelect" class="form-label">å®Ÿè¡Œã™ã‚‹HUGANJOBãƒ—ãƒ­ã‚»ã‚¹</label>
                                        <select class="form-select" id="commandSelect" name="command">
                                            <option value="huganjob_unified_sender.py">HUGANJOBçµ±åˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ¨å¥¨ï¼‰</option>
                                            <option value="huganjob_bulk_email_sender.py">HUGANJOBä¸€æ‹¬ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆå¾“æ¥ç‰ˆï¼‰</option>
                                            <option value="huganjob_email_address_resolver.py">HUGANJOBãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ±ºå®š</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="startIdInput" class="form-label">é–‹å§‹ä¼æ¥­ID</label>
                                        <input type="number" class="form-control" id="startIdInput" name="start_id" placeholder="ä¾‹: 1" min="1" value="1">
                                    </div>
                                    <div class="mb-3">
                                        <label for="endIdInput" class="form-label">çµ‚äº†ä¼æ¥­ID</label>
                                        <input type="number" class="form-control" id="endIdInput" name="end_id" placeholder="ä¾‹: 100">
                                        <small class="form-text text-muted">ç©ºç™½ã®å ´åˆã¯æœ€å¾Œã¾ã§å‡¦ç†ã—ã¾ã™</small>
                                    </div>

                                    <!-- ãƒ¡ãƒ¼ãƒ«å½¢å¼é¸æŠ -->
                                    <div class="mb-3">
                                        <label for="emailFormatSelect" class="form-label">ãƒ¡ãƒ¼ãƒ«å½¢å¼</label>
                                        <select class="form-select" id="emailFormatSelect" name="email_format">
                                            <option value="html_text">HTML + ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ¨å¥¨ï¼‰</option>
                                            <option value="html_only">HTMLã®ã¿</option>
                                            <option value="text_only">ãƒ†ã‚­ã‚¹ãƒˆã®ã¿</option>
                                        </select>
                                        <small class="form-text text-muted">HTMLãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºå•é¡ŒãŒã‚ã‚‹å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’é¸æŠ</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="argsInput" class="form-label">ãã®ä»–ã®å¼•æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                                        <input type="text" class="form-control" id="argsInput" name="args" placeholder="ä¾‹: --limit 10">
                                    </div>

                                    <!-- ãƒãƒƒãƒå‡¦ç†è¨­å®š -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">ãƒãƒƒãƒå‡¦ç†è¨­å®š</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="batchModeCheck" name="batch_mode">
                                                <label class="form-check-label" for="batchModeCheck">
                                                    ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                                                </label>
                                                <small class="form-text text-muted d-block">100ç¤¾ä»¥ä¸Šã®å‡¦ç†ã§ã¯è‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™</small>
                                            </div>
                                            <div class="mb-2">
                                                <label for="batchSizeInput" class="form-label">ãƒãƒƒãƒã‚µã‚¤ã‚º</label>
                                                <select class="form-select" id="batchSizeInput" name="batch_size">
                                                    <option value="10">10ç¤¾ãšã¤ï¼ˆæœ€ã‚‚å®‰å…¨ï¼‰</option>
                                                    <option value="20" selected>20ç¤¾ãšã¤ï¼ˆæ¨å¥¨ï¼‰</option>
                                                    <option value="50">50ç¤¾ãšã¤ï¼ˆé«˜é€Ÿï¼‰</option>
                                                </select>
                                                <small class="form-text text-muted">å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ™‚ã®åˆ†å‰²ã‚µã‚¤ã‚º</small>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary">ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹</button>
                                </form>

                                <hr>

                                <!-- ãƒ¡ãƒ¼ãƒ«å½¢å¼é¸æŠä»˜ãé€ä¿¡ -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">ğŸ“§ ãƒ¡ãƒ¼ãƒ«å½¢å¼é¸æŠé€ä¿¡</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label for="quickStartId" class="form-label">é–‹å§‹ID</label>
                                                <input type="number" class="form-control" id="quickStartId" value="1" min="1">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="quickEndId" class="form-label">çµ‚äº†ID</label>
                                                <input type="number" class="form-control" id="quickEndId" value="10" min="1">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="quickEmailFormat" class="form-label">ãƒ¡ãƒ¼ãƒ«å½¢å¼</label>
                                                <select class="form-select" id="quickEmailFormat">
                                                    <option value="html_text">HTML + ãƒ†ã‚­ã‚¹ãƒˆ</option>
                                                    <option value="html_only">HTMLã®ã¿</option>
                                                    <option value="text_only">ãƒ†ã‚­ã‚¹ãƒˆã®ã¿</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-primary" onclick="huganjobFlexibleSend()">
                                                <i class="fas fa-paper-plane me-1"></i>ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Ÿè¡Œ
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-danger" onclick="huganjobProductionSend()">
                                        <i class="fas fa-paper-plane me-1"></i>ğŸš€ æœ¬ç•ªãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆID 1-10ï¼‰
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="huganjobUnifiedSend()">
                                        <i class="fas fa-shield-alt me-1"></i>HUGANJOB çµ±åˆé€ä¿¡ï¼ˆID 1-10ï¼‰
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="huganjobTextOnlySend()">
                                        <i class="fas fa-file-text me-1"></i>ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆID 1-10ï¼‰
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="huganjobBulkSend()">
                                        <i class="fas fa-rocket me-1"></i>HUGANJOB å¤§é‡é€ä¿¡ï¼ˆID 1-50ï¼‰
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="huganjobEmailResolution()">
                                        <i class="fas fa-search me-1"></i>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ±ºå®šï¼ˆID 1-50ï¼‰
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="huganjobStats()">
                                        <i class="fas fa-chart-bar me-1"></i>HUGANJOBçµ±è¨ˆæƒ…å ±è¡¨ç¤º
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title">å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹</h5>
                                <button id="refreshBtn" class="btn btn-sm btn-outline-primary">æ›´æ–°</button>
                            </div>
                            <div class="card-body">
                                <div id="processesContainer">
                                    {% if processes %}
                                    <ul class="list-group">
                                        {% for process in processes %}
                                        <li class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6>{{ process.description }}</h6>
                                                    <small class="text-muted">é–‹å§‹: {{ process.start_time }}</small>
                                                    <small class="text-muted d-block">å®Ÿè¡Œæ™‚é–“: {{ process.duration }}</small>
                                                    {% if process.has_error %}
                                                    <div class="alert alert-danger mt-2 mb-0 py-1 px-2">
                                                        <small><strong>ã‚¨ãƒ©ãƒ¼:</strong> {{ process.error_message }}</small>
                                                        <button class="btn btn-sm btn-link p-0 ms-2 view-error-btn" data-process-id="{{ process.id }}">è©³ç´°ã‚’è¡¨ç¤º</button>
                                                    </div>
                                                    {% endif %}
                                                    {% if process.status == 'suspicious' and process.warning %}
                                                    <div class="alert alert-warning mt-2 mb-0 py-1 px-2">
                                                        <small><strong>è­¦å‘Š:</strong> {{ process.warning }}</small>
                                                        <button class="btn btn-sm btn-link p-0 ms-2 view-error-btn" data-process-id="{{ process.id }}">è©³ç´°ã‚’è¡¨ç¤º</button>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <span class="badge bg-{{ 'primary' if process.status == 'running' else 'success' if process.status == 'completed' else 'warning' if process.status == 'suspicious' else 'danger' }}">
                                                        {{ 'å®Ÿè¡Œä¸­' if process.status == 'running' else 'å®Œäº†' if process.status == 'completed' else 'è¦ç¢ºèª' if process.status == 'suspicious' else 'ã‚¨ãƒ©ãƒ¼' }}
                                                    </span>
                                                    {% if process.status == 'running' %}
                                                    <button class="btn btn-sm btn-danger stop-process-btn" data-process-id="{{ process.id }}">åœæ­¢</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p class="text-center">å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title">ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œå±¥æ­´</h5>
                                <button id="refreshHistoryBtn" class="btn btn-sm btn-outline-primary">æ›´æ–°</button>
                            </div>
                            <div class="card-body">
                                <div id="processHistoryContainer">
                                    <p class="text-center">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="errorDetailModal" tabindex="-1" aria-labelledby="errorDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorDetailModalLabel">ã‚¨ãƒ©ãƒ¼è©³ç´°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>ã‚³ãƒãƒ³ãƒ‰æƒ…å ±</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>ã‚³ãƒãƒ³ãƒ‰:</strong> <span id="errorCommand"></span></p>
                                <p><strong>å¼•æ•°:</strong> <span id="errorArgs"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>é–‹å§‹æ™‚é–“:</strong> <span id="errorStartTime"></span></p>
                                <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span id="errorStatus"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h6>
                        <div class="alert alert-danger" id="errorMessage"></div>
                    </div>
                    <div class="mb-3">
                        <h6>è©³ç´°ãƒ­ã‚°</h6>
                        <div class="card">
                            <div class="card-body bg-dark text-light">
                                <pre id="errorLog" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* HUGANJOBå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .huganjob-card {
            transition: all 0.3s ease;
        }
        .huganjob-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
    <script>
        // ã‚¨ãƒ©ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
        const errorModal = new bootstrap.Modal(document.getElementById('errorDetailModal'));

        // HUGANJOBå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ  - å–¶æ¥­ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é¸æŠæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿

        // ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ã‚’å®šæœŸçš„ã«æ›´æ–°
        function updateProcesses() {
            fetch('/api/get_processes')
                .then(response => response.json())
                .then(processes => {
                    const container = document.getElementById('processesContainer');
                    if (processes.length === 0) {
                        container.innerHTML = '<p class="text-center">å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';

                        return;
                    }



                    let html = '<ul class="list-group">';
                    processes.forEach(process => {
                        html += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6>${process.description}</h6>
                                        <small class="text-muted">é–‹å§‹: ${process.start_time}</small>
                                        <small class="text-muted d-block">å®Ÿè¡Œæ™‚é–“: ${process.duration}</small>`;

                        if (process.has_error) {
                            html += `
                                <div class="alert alert-danger mt-2 mb-0 py-1 px-2">
                                    <small><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${process.error_message}</small>
                                    <button class="btn btn-sm btn-link p-0 ms-2 view-error-btn" data-process-id="${process.id}">è©³ç´°ã‚’è¡¨ç¤º</button>
                                </div>`;
                        }

                        if (process.status === 'suspicious' && process.warning) {
                            html += `
                                <div class="alert alert-warning mt-2 mb-0 py-1 px-2">
                                    <small><strong>è­¦å‘Š:</strong> ${process.warning}</small>
                                    <button class="btn btn-sm btn-link p-0 ms-2 view-error-btn" data-process-id="${process.id}">è©³ç´°ã‚’è¡¨ç¤º</button>
                                </div>`;
                        }

                        html += `
                                    </div>
                                    <div>
                                        <span class="badge bg-${process.status === 'running' ? 'primary' : process.status === 'completed' ? 'success' : process.status === 'suspicious' ? 'warning' : 'danger'}">
                                            ${process.status === 'running' ? 'å®Ÿè¡Œä¸­' : process.status === 'completed' ? 'å®Œäº†' : process.status === 'suspicious' ? 'è¦ç¢ºèª' : 'ã‚¨ãƒ©ãƒ¼'}
                                        </span>`;

                        if (process.status === 'running') {
                            html += `<button class="btn btn-sm btn-danger stop-process-btn" data-process-id="${process.id}">åœæ­¢</button>`;
                        }

                        html += `
                                    </div>
                                </div>
                            </li>`;
                    });
                    html += '</ul>';
                    container.innerHTML = html;

                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                    setupEventListeners();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        function setupEventListeners() {
            // ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢ãƒœã‚¿ãƒ³
            document.querySelectorAll('.stop-process-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const processId = this.getAttribute('data-process-id');
                    stopProcess(processId);
                });
            });

            // ã‚¨ãƒ©ãƒ¼è©³ç´°è¡¨ç¤ºãƒœã‚¿ãƒ³
            document.querySelectorAll('.view-error-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const processId = this.getAttribute('data-process-id');
                    showErrorDetails(processId);
                });
            });
        }

        // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
        function showErrorDetails(processId) {
            fetch(`/api/process_error/${processId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success === false) {
                        alert(data.message);
                        return;
                    }

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    document.getElementById('errorCommand').textContent = data.command;
                    document.getElementById('errorArgs').textContent = data.args || '(ãªã—)';
                    document.getElementById('errorStartTime').textContent = data.start_time;
                    document.getElementById('errorStatus').textContent = data.status === 'failed' ? 'ã‚¨ãƒ©ãƒ¼' : data.status === 'error' ? 'ç›£è¦–ã‚¨ãƒ©ãƒ¼' : data.status;
                    document.getElementById('errorMessage').textContent = data.error_message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';

                    // ãƒ­ã‚°ãŒã‚ã‚Œã°è¡¨ç¤º
                    const logElement = document.getElementById('errorLog');
                    if (data.error_log) {
                        logElement.textContent = data.error_log;
                    } else if (data.output) {
                        logElement.textContent = data.output;
                    } else {
                        logElement.textContent = 'è©³ç´°ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“';
                    }

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    errorModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼è©³ç´°ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
        }

        // ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
        function stopProcess(processId) {
            if (confirm('ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                fetch(`/api/stop_process/${processId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        updateProcesses();
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        // HUGANJOBå°‚ç”¨é–¢æ•°ï¼ˆçµ±åˆã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ï¼‰
        function huganjobProductionSend() {
            if (confirm('ğŸš¨ æœ¬ç•ªãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡: ID 1-10 (10ç¤¾)\n\nâœ… é‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½æœ‰åŠ¹\nâœ… ãƒã‚¦ãƒ³ã‚¹é™¤å¤–æ©Ÿèƒ½æœ‰åŠ¹\nâœ… é€ä¿¡é–“éš”åˆ¶å¾¡æœ‰åŠ¹\n\nâš ï¸ å®Ÿéš›ã®å–¶æ¥­ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™')) {
                fetch('/api/huganjob/production_send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_id: 1, end_id: 10 })
                })
                .then(response => response.json())
                .then(data => {
                    let message = data.success ? data.message : 'ã‚¨ãƒ©ãƒ¼: ' + data.message;
                    if (data.success && data.safety_features) {
                        message += '\n\nğŸ›¡ï¸ å®‰å…¨æ©Ÿèƒ½:\n' + data.safety_features.join('\n');
                        message += '\n\nğŸ“§ é€ä¿¡è€…: ' + data.sender;
                        message += '\nğŸ“¡ SMTP: ' + data.smtp_server;
                    }
                    alert(message);
                    if (data.success) updateProcesses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function huganjobUnifiedSend() {
            if (confirm('HUGANJOBçµ±åˆå–¶æ¥­ãƒ¡ãƒ¼ãƒ«ï¼ˆID 1-10ï¼‰ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\né‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™ã€‚')) {
                fetch('/api/huganjob/bulk_send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_id: 1, end_id: 10, max_emails: 10 })
                })
                .then(response => response.json())
                .then(data => {
                    let message = data.success ? data.message : 'ã‚¨ãƒ©ãƒ¼: ' + data.message;
                    if (data.success && data.duplicate_prevention) {
                        message += '\n\nâœ… é‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™';
                    }
                    alert(message);
                    if (data.success) updateProcesses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function huganjobTextOnlySend() {
            if (confirm('ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡: ID 1-10 (10ç¤¾)\nå½¢å¼: ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆHTMLãªã—ï¼‰\nç›®çš„: HTMLãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºå•é¡Œå¯¾å¿œ\n\nâœ… é‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½æœ‰åŠ¹\nâœ… ãƒã‚¦ãƒ³ã‚¹é™¤å¤–æ©Ÿèƒ½æœ‰åŠ¹\nâœ… é…ä¿¡åœæ­¢ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹\nâœ… é€ä¿¡é–“éš”åˆ¶å¾¡æœ‰åŠ¹\n\nâš ï¸ å®Ÿéš›ã®å–¶æ¥­ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™')) {
                fetch('/api/huganjob/text_only_send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_id: 1, end_id: 10 })
                })
                .then(response => response.json())
                .then(data => {
                    let message = data.success ? data.message : 'ã‚¨ãƒ©ãƒ¼: ' + data.message;
                    if (data.success) {
                        message += '\n\nğŸ“ ãƒ¡ãƒ¼ãƒ«å½¢å¼: ' + data.email_type;
                        message += '\nğŸ¯ ç›®çš„: ' + data.purpose;
                        message += '\nğŸ›¡ï¸ å®‰å…¨æ©Ÿèƒ½: ' + data.safety_features.join(', ');
                    }
                    alert(message);
                    if (data.success) updateProcesses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function huganjobFlexibleSend() {
            const startId = document.getElementById('quickStartId').value;
            const endId = document.getElementById('quickEndId').value;
            const emailFormat = document.getElementById('quickEmailFormat').value;

            let formatText = '';
            let apiEndpoint = '';

            switch(emailFormat) {
                case 'html_text':
                    formatText = 'HTML + ãƒ†ã‚­ã‚¹ãƒˆ';
                    apiEndpoint = '/api/huganjob/flexible_send';
                    break;
                case 'html_only':
                    formatText = 'HTMLã®ã¿';
                    apiEndpoint = '/api/huganjob/production_send';
                    break;
                case 'text_only':
                    formatText = 'ãƒ†ã‚­ã‚¹ãƒˆã®ã¿';
                    apiEndpoint = '/api/huganjob/text_only_send';
                    break;
            }

            if (confirm(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾è±¡: ID ${startId}-${endId}\nå½¢å¼: ${formatText}\n\nâœ… é‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½æœ‰åŠ¹\nâœ… ãƒã‚¦ãƒ³ã‚¹é™¤å¤–æ©Ÿèƒ½æœ‰åŠ¹\nâœ… é…ä¿¡åœæ­¢ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹\nâœ… é€ä¿¡é–“éš”åˆ¶å¾¡æœ‰åŠ¹\n\nâš ï¸ å®Ÿéš›ã®å–¶æ¥­ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™`)) {
                fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_id: parseInt(startId),
                        end_id: parseInt(endId),
                        email_format: emailFormat
                    })
                })
                .then(response => response.json())
                .then(data => {
                    let message = data.success ? data.message : 'ã‚¨ãƒ©ãƒ¼: ' + data.message;
                    if (data.success) {
                        if (data.email_type) message += '\n\nğŸ“ ãƒ¡ãƒ¼ãƒ«å½¢å¼: ' + data.email_type;
                        if (data.purpose) message += '\nğŸ¯ ç›®çš„: ' + data.purpose;
                        if (data.safety_features) message += '\nğŸ›¡ï¸ å®‰å…¨æ©Ÿèƒ½: ' + data.safety_features.join(', ');
                        if (data.system) message += '\nâš™ï¸ é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ : ' + data.system;
                    }
                    alert(message);
                    if (data.success) updateProcesses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function huganjobBulkSend() {
            if (confirm('HUGANJOBå¤§é‡å–¶æ¥­ãƒ¡ãƒ¼ãƒ«ï¼ˆID 1-50ï¼‰ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\né‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™ã€‚')) {
                fetch('/api/huganjob/bulk_send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_id: 1, end_id: 50, max_emails: 50 })
                })
                .then(response => response.json())
                .then(data => {
                    let message = data.success ? data.message : 'ã‚¨ãƒ©ãƒ¼: ' + data.message;
                    if (data.success && data.duplicate_prevention) {
                        message += '\n\nâœ… é‡è¤‡é€ä¿¡é˜²æ­¢æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™';
                    }
                    alert(message);
                    if (data.success) updateProcesses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function huganjobEmailResolution() {
            if (confirm('HUGANJOBãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ±ºå®šï¼ˆID 1-50ï¼‰ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                fetch('/api/huganjob/email_resolution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_id: 1, end_id: 50 })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.success ? data.message : 'ã‚¨ãƒ©ãƒ¼: ' + data.message);
                    if (data.success) updateProcesses();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            }
        }

        function huganjobStats() {
            fetch('/api/huganjob/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        let message = 'HUGANJOBå–¶æ¥­ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµ±è¨ˆ:\n\n';
                        message += `ç·ä¼æ¥­æ•°: ${stats.total_companies}ç¤¾\n`;
                        message += `ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ±ºå®šæ¸ˆã¿: ${stats.email_resolved}ç¤¾\n`;
                        message += `ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¸ˆã¿: ${stats.emails_sent}ç¤¾\n`;
                        message += `é…ä¿¡æˆåŠŸ: ${stats.delivery_success}ç¤¾\n`;
                        message += `ãƒã‚¦ãƒ³ã‚¹: ${stats.bounced}ç¤¾\n`;
                        message += `æˆåŠŸç‡: ${stats.success_rate}%\n`;
                        message += `\næœ€çµ‚æ›´æ–°: ${data.last_updated}`;
                        alert(message);
                    } else {
                        alert('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('çµ±è¨ˆæƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
        }

        // åˆæœŸè¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupEventListeners();

            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: é«˜å“è³ªä¿®å¾©å‡¦ç†ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: é«˜å“è³ªå‡¦ç†åœæ­¢ãƒœã‚¿ãƒ³
            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: é«˜å“è³ªä¿®å¾©çŠ¶æ³ã®åˆæœŸèª­ã¿è¾¼ã¿

            // ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
            updateProcessHistory();

            // 30ç§’ã”ã¨ã«ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ã‚’æ›´æ–°
            setInterval(updateProcesses, 30000);

            // 60ç§’ã”ã¨ã«ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ã‚’æ›´æ–°
            setInterval(updateProcessHistory, 60000);

            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: é€ä¿¡è¨˜éŒ²ã®æ•´åˆæ€§ã‚’ä¿®æ­£ã™ã‚‹ãƒœã‚¿ãƒ³
            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿ã™ã‚‹ãƒœã‚¿ãƒ³



            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆãƒœã‚¿ãƒ³
            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆæƒ…å ±ãƒœã‚¿ãƒ³
            // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã™ã‚‹ãƒœã‚¿ãƒ³
        });

        // ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ã‚’æ›´æ–°
        function updateProcessHistory() {
            fetch('/api/get_process_history?limit=5')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('processHistoryContainer');

                    // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã®å ´åˆï¼ˆæ­£å¸¸ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
                    if (Array.isArray(data)) {
                        const history = data;
                        if (history.length === 0) {
                            container.innerHTML = '<p class="text-center">ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                            return;
                        }
                        renderProcessHistory(history, container);
                        return;
                    }

                    // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆ
                    if (data.error) {
                        container.innerHTML = '<div class="alert alert-danger">å±¥æ­´ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error + '</div>';
                        return;
                    }

                    // æ—§å½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆsuccess ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆï¼‰
                    if (data.success === false) {
                        container.innerHTML = '<div class="alert alert-danger">å±¥æ­´ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + '</div>';
                        return;
                    }

                    const history = data.history || data || [];
                    if (history.length === 0) {
                        container.innerHTML = '<p class="text-center">ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                        return;
                    }

                    renderProcessHistory(history, container);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('processHistoryContainer').innerHTML =
                        '<div class="alert alert-danger">å±¥æ­´ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</div>';
                });
        }

        // ãƒ—ãƒ­ã‚»ã‚¹å±¥æ­´ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderProcessHistory(history, container) {
            let html = '<ul class="list-group">';
            history.forEach(process => {
                // é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“
                const startTime = process.start_time || 'ä¸æ˜';
                const endTime = process.end_time || 'ä¸æ˜';

                // å®Ÿè¡Œæ™‚é–“ã®è¨ˆç®—
                let duration = 'ä¸æ˜';
                if (process.start_time && process.end_time) {
                    const start = new Date(process.start_time);
                    const end = new Date(process.end_time);
                    const diff = Math.floor((end - start) / 1000);

                    const hours = Math.floor(diff / 3600);
                    const minutes = Math.floor((diff % 3600) / 60);
                    const seconds = diff % 60;

                    duration = `${hours > 0 ? hours + 'æ™‚é–“ ' : ''}${minutes > 0 ? minutes + 'åˆ† ' : ''}${seconds}ç§’`;
                }

                // èª¬æ˜æ–‡
                let description = process.description || process.command;
                if (!description && process.command) {
                    // ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
                    const command = process.command;
                    const args = process.args || [];

                    if (command === 'analyze_websites_new_criteria.py' || command.includes('analyze_websites')) {
                        description = 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆåˆ†æ';
                    } else if (command === 'prioritized_email_extractor.py' || command.includes('extract')) {
                        description = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æŠ½å‡º';
                    } else if (command === 'send_marketing_emails_batch.py' || command.includes('send_email')) {
                        description = 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«é€ä¿¡';

                    } else {
                        description = command;
                    }
                }

                html += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>${description}</h6>
                                <small class="text-muted">é–‹å§‹: ${startTime}</small>
                                <small class="text-muted d-block">çµ‚äº†: ${endTime}</small>
                                <small class="text-muted d-block">å®Ÿè¡Œæ™‚é–“: ${duration}</small>`;

                if (process.status === 'failed' || process.status === 'error' || process.has_error) {
                    html += `
                        <div class="alert alert-danger mt-2 mb-0 py-1 px-2">
                            <small><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${process.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</small>
                            <button class="btn btn-sm btn-link p-0 ms-2 view-history-error-btn" data-process-id="${process.id}">è©³ç´°ã‚’è¡¨ç¤º</button>
                        </div>`;
                }

                html += `
                            </div>
                            <div>
                                <span class="badge bg-${process.status === 'running' ? 'primary' : process.status === 'completed' ? 'success' : process.status === 'suspicious' ? 'warning' : 'danger'}">
                                    ${process.status === 'running' ? 'å®Ÿè¡Œä¸­' : process.status === 'completed' ? 'å®Œäº†' : process.status === 'suspicious' ? 'è¦ç¢ºèª' : 'ã‚¨ãƒ©ãƒ¼'}
                                </span>`;

                // å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯çŠ¶æ…‹æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                if (process.status === 'running') {
                    html += `
                                <button class="btn btn-sm btn-warning ms-2 update-process-status-btn" data-process-id="${process.id}">
                                    å®Œäº†ã«ã™ã‚‹
                                </button>`;
                }

                html += `
                            </div>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;

            // å±¥æ­´ã®ã‚¨ãƒ©ãƒ¼è©³ç´°è¡¨ç¤ºãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.view-history-error-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const processId = this.getAttribute('data-process-id');
                    showErrorDetails(processId);
                });
            });
        }

        // æ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refreshBtn').addEventListener('click', function() {
            updateProcesses();
        });

        // å±¥æ­´æ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refreshHistoryBtn').addEventListener('click', function() {
            updateProcessHistory();
        });

        // ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('startProcessForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const command = document.getElementById('commandSelect').value;
            const startId = document.getElementById('startIdInput').value;
            const endId = document.getElementById('endIdInput').value;
            const otherArgs = document.getElementById('argsInput').value;
            const batchMode = document.getElementById('batchModeCheck').checked;
            const batchSize = document.getElementById('batchSizeInput').value;

            // ä¼æ¥­IDç¯„å›²ã®å¼•æ•°ã‚’æ§‹ç¯‰
            let args = otherArgs;
            if (startId) {
                args = (args ? args + ' ' : '') + `--start-id ${startId}`;
            }
            if (endId) {
                args = (args ? args + ' ' : '') + `--end-id ${endId}`;
            }



            // ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯
            if (startId && endId) {
                const rangeSize = parseInt(endId) - parseInt(startId) + 1;
                if (rangeSize >= 100 && !batchMode) {
                    if (confirm(`å‡¦ç†ç¯„å›²ãŒ${rangeSize}ç¤¾ã¨å¤§ãã„ãŸã‚ã€ãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚\n\nãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        document.getElementById('batchModeCheck').checked = true;
                    }
                }
            }

            fetch('/api/start_process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `command=${encodeURIComponent(command)}&args=${encodeURIComponent(args)}&batch_mode=${batchMode}&batch_size=${batchSize}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = data.message;
                    if (data.batch_mode) {
                        message += `\n\nãƒãƒƒãƒãƒ¢ãƒ¼ãƒ‰: ${data.batch_size}ç¤¾ãšã¤å‡¦ç†`;
                        if (data.estimated_batches) {
                            message += `\näºˆæƒ³ãƒãƒƒãƒæ•°: ${data.estimated_batches}`;
                        }
                    }
                    alert(message);
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        });

        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: 100ç¤¾å˜ä½ãƒãƒƒãƒå‡¦ç†ãƒœã‚¿ãƒ³
        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒãƒƒãƒå‡¦ç†ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒãƒƒãƒå‡¦ç†å®Ÿè¡Œé–¢æ•°
        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: é€²æ—æƒ…å ±ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ç¯„å›²æŒ‡å®šã§çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ãƒœã‚¿ãƒ³

                // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ç¯„å›²æŒ‡å®šã§çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹ã‚³ãƒ¼ãƒ‰
                // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒœã‚¿ãƒ³

        // ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢ãƒœã‚¿ãƒ³
        document.querySelectorAll('.stop-process-btn').forEach(button => {
            button.addEventListener('click', function() {
                const processId = this.getAttribute('data-process-id');
                if (confirm('ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    fetch(`/api/stop_process/${processId}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    });
                }
            });
        });



        // ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ã‚’æ‰‹å‹•ã§æ›´æ–°
        function updateProcessStatus(processId, status = 'completed') {
            if (!confirm('ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const formData = new FormData();
            formData.append('process_id', processId);
            formData.append('status', status);

            fetch('/api/update_process_status', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    updateProcessHistory();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã«å¯¾å¿œï¼‰
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('update-process-status-btn')) {
                const processId = e.target.getAttribute('data-process-id');
                updateProcessStatus(processId);
            }
        });

        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // å‰Šé™¤ã•ã‚ŒãŸé …ç›®: ãƒã‚¦ãƒ³ã‚¹å‡¦ç†çŠ¶æ³ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateProcesses();
            updateProcessHistory();
            setInterval(updateProcesses, 5000);
            setInterval(updateProcessHistory, 10000);
        });
    </script>
</body>
</html>
