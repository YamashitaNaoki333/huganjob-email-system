{% extends "base.html" %}

{% block title %}HUGANJOBÂñ∂Ê•≠„É°„Éº„É´ÈÄÅ‰ø°„Ç∑„Çπ„ÉÜ„É† - „É°„Ç§„É≥„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block page_title %}HUGANJOBÂñ∂Ê•≠„É°„Éº„É´ÈÄÅ‰ø°„Ç∑„Çπ„ÉÜ„É†{% endblock %}
{% block page_description %}Êé°Áî®Âñ∂Ê•≠„É°„Éº„É´‰∏ÄÊã¨ÈÄÅ‰ø°„ÉªÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†{% endblock %}

{% block content %}
        <!-- HUGANJOBÁµ±Âêà„É°„Éº„É´ÈÄÅ‰ø°Âà∂Âæ° -->
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-paper-plane me-2"></i>HUGANJOBÁµ±Âêà„É°„Éº„É´ÈÄÅ‰ø°
                        </h5>
                        <small>huganjob_unified_sender.py --email-format html_only</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="startId" class="form-label">ÈñãÂßãID</label>
                                <input type="number" class="form-control" id="startId" value="4841" min="1">
                            </div>
                            <div class="col-md-6">
                                <label for="endId" class="form-label">ÁµÇ‰∫ÜID</label>
                                <input type="number" class="form-control" id="endId" value="4841" min="1">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-lg" onclick="huganjobSend()">
                                <i class="fas fa-paper-plane me-1"></i>„É°„Éº„É´ÈÄÅ‰ø°ÂÆüË°å
                            </button>
                            <button type="button" class="btn btn-info btn-sm ms-2" onclick="manualStartProgressMonitoring()">
                                <i class="fas fa-chart-line me-1"></i>ÈÄ≤Ë°åÁä∂Ê≥ÅË°®Á§∫
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">
                                    ÂÆüË°å„Ç≥„Éû„É≥„Éâ: <code>python huganjob_unified_sender.py --start-id <span id="cmdStartId">4841</span> --end-id <span id="cmdEndId">4841</span> --email-format html_only</code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <!-- üÜï „É™„Ç¢„É´„Çø„Ç§„É†ÈÄ≤Ë°åÁä∂Ê≥ÅË°®Á§∫ -->
                <div class="card mb-4" id="progressCard" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>ÈÄÅ‰ø°ÈÄ≤Ë°åÁä∂Ê≥Å
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="progressInfo">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>ÈÄ≤Ë°åÁä∂Ê≥Å</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="progress">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end">
                                        <div class="h5 mb-0" id="processedCount">0</div>
                                        <small class="text-muted">Âá¶ÁêÜÊ∏à„Åø</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="h5 mb-0" id="totalCount">0</div>
                                    <small class="text-muted">Á∑èÊï∞</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="row text-center">
                                    <div class="col-3">
                                        <div class="text-success h6 mb-0" id="successCount">0</div>
                                        <small class="text-muted">ÊàêÂäü</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-danger h6 mb-0" id="failedCount">0</div>
                                        <small class="text-muted">Â§±Êïó</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-warning h6 mb-0" id="skippedCount">0</div>
                                        <small class="text-muted">„Çπ„Ç≠„ÉÉ„Éó</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-info h6 mb-0" id="bouncedCount">0</div>
                                        <small class="text-muted">„Éê„Ç¶„É≥„Çπ</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ÊÆã„ÇäÊôÇÈñì: <span id="estimatedTime">Ë®àÁÆó‰∏≠...</span>
                                </small>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-envelope me-1"></i>
                                    ÁèæÂú®Âá¶ÁêÜ‰∏≠: ID <span id="currentCompany">-</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>ÈÄÅ‰ø°Ë®≠ÂÆö
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><i class="fas fa-check text-success me-2"></i>ÈáçË§áÈÄÅ‰ø°Èò≤Ê≠¢</li>
                            <li><i class="fas fa-check text-success me-2"></i>„Éê„Ç¶„É≥„ÇπÈô§Â§ñ</li>
                            <li><i class="fas fa-check text-success me-2"></i>ÈÖç‰ø°ÂÅúÊ≠¢„ÉÅ„Çß„ÉÉ„ÇØ</li>
                            <li><i class="fas fa-check text-success me-2"></i>HTMLÂΩ¢Âºè„ÅÆ„Åø</li>
                            <li><i class="fas fa-check text-success me-2"></i>5ÁßíÈÄÅ‰ø°ÈñìÈöî</li>
                        </ul>
                    </div>
            </div>
        </div>

        <!-- Áõ¥Ëøë„ÅÆ„Éó„É≠„Çª„ÇπÂ±•Ê≠¥„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>Áõ¥Ëøë„ÅÆ„Éó„É≠„Çª„ÇπÂ±•Ê≠¥Ôºà3‰ª∂Ôºâ
                        </h5>
                        <button id="refreshHistoryBtn" class="btn btn-sm btn-outline-secondary">Êõ¥Êñ∞</button>
                    </div>
                    <div class="card-body">
                        <div id="historyContainer">
                            {% if recent_history %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>„Éó„É≠„Çª„Çπ</th>
                                            <th>„Ç≥„Éû„É≥„Éâ</th>
                                            <th>ÈñãÂßãÊôÇÂàª</th>
                                            <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                            <th>ÁµÇ‰∫Ü„Ç≥„Éº„Éâ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for history in recent_history %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-secondary">{{ history.id }}</span>
                                            </td>
                                            <td>
                                                <code class="small">{{ history.command }}</code>
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ history.start_time }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if history.status == 'completed' else 'primary' if history.status == 'running' else 'warning' if history.status == 'suspicious' else 'danger' }}">
                                                    {{ 'ÂÆå‰∫Ü' if history.status == 'completed' else 'ÂÆüË°å‰∏≠' if history.status == 'running' else 'Ë¶ÅÁ¢∫Ë™ç' if history.status == 'suspicious' else '„Ç®„É©„Éº' if history.status == 'error' else history.status }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if history.return_code is not none %}
                                                    <span class="badge bg-{{ 'success' if history.return_code == 0 else 'danger' }}">
                                                        {{ history.return_code }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p class="mb-0">„Éó„É≠„Çª„ÇπÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>


    // IDÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂÄ§„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´„Ç≥„Éû„É≥„ÉâË°®Á§∫„ÇíÊõ¥Êñ∞
    function updateCommand() {
        const startId = document.getElementById('startId').value;
        const endId = document.getElementById('endId').value;
        document.getElementById('cmdStartId').textContent = startId;
        document.getElementById('cmdEndId').textContent = endId;
    }

    // HUGANJOBÁµ±Âêà„É°„Éº„É´ÈÄÅ‰ø°
    function huganjobSend() {
        const startId = document.getElementById('startId').value;
        const endId = document.getElementById('endId').value;

        if (confirm(`HUGANJOBÁµ±Âêà„É°„Éº„É´ÈÄÅ‰ø°„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\n\nÂØæË±°: ID ${startId}-${endId}\n\nÂÆüË°å„Ç≥„Éû„É≥„Éâ:\npython huganjob_unified_sender.py --start-id ${startId} --end-id ${endId} --email-format html_only\n\n‚ö†Ô∏è ÂÆüÈöõ„ÅÆÂñ∂Ê•≠„É°„Éº„É´„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô`)) {
            fetch('/api/huganjob/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    start_id: parseInt(startId),
                    end_id: parseInt(endId)
                })
            })
            .then(response => response.json())
            .then(data => {
                let message = data.success ? data.message : '„Ç®„É©„Éº: ' + data.message;
                if (data.success && data.command) {
                    message += '\n\nÂÆüË°å„Ç≥„Éû„É≥„Éâ: ' + data.command;
                    // üÜï ÈÄÅ‰ø°ÈñãÂßãÊôÇ„Å´ÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñ„ÇíÈñãÂßã
                    if (data.process_id) {
                        startProgressMonitoring(data.process_id);
                    }
                }
                alert(message);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }
    }

    // üÜï ÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñÊ©üËÉΩ
    let progressMonitoringInterval = null;

    function startProgressMonitoring(processId) {
        console.log('üöÄ ÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñÈñãÂßã:', processId);

        // ÈÄ≤Ë°åÁä∂Ê≥Å„Ç´„Éº„Éâ„ÇíË°®Á§∫
        const progressCard = document.getElementById('progressCard');
        if (progressCard) {
            progressCard.style.display = 'block';
            console.log('‚úÖ ÈÄ≤Ë°åÁä∂Ê≥Å„Ç´„Éº„ÉâË°®Á§∫');
        } else {
            console.error('‚ùå ÈÄ≤Ë°åÁä∂Ê≥Å„Ç´„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            return;
        }

        // Êó¢Â≠ò„ÅÆÁõ£Ë¶ñ„ÇíÂÅúÊ≠¢
        if (progressMonitoringInterval) {
            clearInterval(progressMonitoringInterval);
        }

        // ÂÆöÊúüÁöÑ„Å´ÈÄ≤Ë°åÁä∂Ê≥Å„ÇíÊõ¥Êñ∞Ôºà3ÁßíÈñìÈöîÔºâ
        progressMonitoringInterval = setInterval(() => {
            updateProgress(processId);
        }, 3000);

        // ÂàùÂõûÊõ¥Êñ∞
        updateProgress(processId);
        console.log('‚è∞ ÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñ„Çø„Ç§„Éû„ÉºÈñãÂßãÔºà3ÁßíÈñìÈöîÔºâ');
    }

    function updateProgress(processId) {
        console.log('üìä ÈÄ≤Ë°åÁä∂Ê≥ÅÊõ¥Êñ∞‰∏≠...', processId);

        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„ÇπAPI„Çí‰ΩøÁî®
        fetch('/api/huganjob/active_processes')
            .then(response => response.json())
            .then(data => {
                console.log('üìà ÈÄ≤Ë°åÁä∂Ê≥Å„Éá„Éº„Çø:', data);

                if (data.success && data.processes && data.processes.length > 0) {
                    // ÊåáÂÆö„Åï„Çå„Åü„Éó„É≠„Çª„ÇπID„Åæ„Åü„ÅØÊúÄÂàù„ÅÆ„Éó„É≠„Çª„Çπ„Çí‰ΩøÁî®
                    let targetProcess = data.processes.find(p => p.process_id === processId);
                    if (!targetProcess) {
                        targetProcess = data.processes[0]; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    }

                    const progress = targetProcess.progress;
                    console.log('üéØ „Éó„É≠„Çª„ÇπÈÄ≤Ë°åÁä∂Ê≥Å:', progress);

                    if (progress && progress.type === 'huganjob_unified_sender') {
                        // ÈÄ≤Ë°åÁä∂Ê≥Å„ÇíÊõ¥Êñ∞
                        updateProgressDisplay(progress);

                        // „Éó„É≠„Çª„Çπ„ÅåÂÆå‰∫Ü„Åó„ÅüÂ†¥Âêà„ÅØÁõ£Ë¶ñ„ÇíÂÅúÊ≠¢
                        if (targetProcess.status === 'completed' || targetProcess.status === 'error') {
                            console.log('üèÅ „Éó„É≠„Çª„ÇπÂÆå‰∫ÜÊ§úÂá∫:', targetProcess.status);
                            stopProgressMonitoring();
                        }
                    } else {
                        console.log('‚ö†Ô∏è HUGANJOBÁµ±ÂêàÈÄÅ‰ø°„Éó„É≠„Çª„Çπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                    }
                } else {
                    console.log('‚ùå „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éó„É≠„Çª„Çπ„Å™„Åó - Áõ£Ë¶ñÂÅúÊ≠¢');
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éó„É≠„Çª„Çπ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁõ£Ë¶ñ„ÇíÂÅúÊ≠¢
                    stopProgressMonitoring();
                }
            })
            .catch(error => {
                console.error('‚ùå ÈÄ≤Ë°åÁä∂Ê≥ÅÂèñÂæó„Ç®„É©„Éº:', error);

                // „Ç®„É©„ÉºÊôÇ„ÅØ‰∏ÄËà¨„Éó„É≠„Çª„ÇπAPI„ÇíË©¶„Åô
                fetch('/api/get_active_processes')
                    .then(response => response.json())
                    .then(generalData => {
                        if (generalData && Array.isArray(generalData)) {
                            const huganjobProcess = generalData.find(p =>
                                p.command && p.command.includes('huganjob_unified_sender')
                            );

                            if (!huganjobProcess) {
                                console.log('‚ùå ‰∏ÄËà¨„Éó„É≠„Çª„ÇπAPI„Åß„ÇÇHUGANJOB„Éó„É≠„Çª„ÇπË¶ã„Å§„Åã„Çâ„Åö');
                                stopProgressMonitoring();
                            }
                        }
                    })
                    .catch(fallbackError => {
                        console.error('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Ç®„É©„Éº:', fallbackError);
                    });
            });
    }

    function updateProgressDisplay(progress) {
        // ÈÄ≤Ë°åÁéá
        const percent = progress.progress_percent || 0;
        document.getElementById('progressPercent').textContent = percent + '%';
        document.getElementById('progressBar').style.width = percent + '%';

        // Âá¶ÁêÜÊï∞
        document.getElementById('processedCount').textContent = progress.processed_companies || 0;
        document.getElementById('totalCount').textContent = progress.total_companies || 0;

        // ÁµêÊûúÁµ±Ë®à
        document.getElementById('successCount').textContent = progress.success_count || 0;
        document.getElementById('failedCount').textContent = progress.failed_count || 0;
        document.getElementById('skippedCount').textContent = progress.skipped_count || 0;
        document.getElementById('bouncedCount').textContent = progress.bounced_count || 0;

        // ÊÆã„ÇäÊôÇÈñì
        document.getElementById('estimatedTime').textContent = progress.estimated_remaining_time || 'Ë®àÁÆó‰∏≠...';

        // ÁèæÂú®Âá¶ÁêÜ‰∏≠„ÅÆ‰ºÅÊ•≠
        document.getElementById('currentCompany').textContent = progress.current_company || '-';

        // ÈÄ≤Ë°åÁéá„Å´Âøú„Åò„Å¶„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆËâ≤„ÇíÂ§âÊõ¥
        const progressBar = document.getElementById('progressBar');
        if (percent >= 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (percent >= 50) {
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
        } else {
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
        }
    }

    function stopProgressMonitoring() {
        console.log('üõë ÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñÂÅúÊ≠¢');

        if (progressMonitoringInterval) {
            clearInterval(progressMonitoringInterval);
            progressMonitoringInterval = null;
        }

        // ÂÆå‰∫ÜÂæå3Áßí„ÅßÈÄ≤Ë°åÁä∂Ê≥Å„Ç´„Éº„Éâ„ÇíÈùûË°®Á§∫
        setTimeout(() => {
            const progressCard = document.getElementById('progressCard');
            if (progressCard) {
                progressCard.style.display = 'none';
                console.log('üì± ÈÄ≤Ë°åÁä∂Ê≥Å„Ç´„Éº„ÉâÈùûË°®Á§∫');
            }
        }, 3000);
    }

    // üÜï ÊâãÂãï„ÅßÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñ„ÇíÈñãÂßã
    function manualStartProgressMonitoring() {
        console.log('üîß ÊâãÂãïÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñÈñãÂßã');

        // „Åæ„ÅöÊó¢Â≠ò„Éó„É≠„Çª„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        fetch('/api/huganjob/active_processes')
            .then(response => response.json())
            .then(data => {
                console.log('üìä ÊâãÂãï„ÉÅ„Çß„ÉÉ„ÇØÁµêÊûú:', data);

                if (data.success && data.processes && data.processes.length > 0) {
                    const process = data.processes[0];
                    console.log('‚úÖ „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„ÇπÁô∫Ë¶ã:', process.process_id);
                    startProgressMonitoring(process.process_id);

                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    alert(`ÈÄ≤Ë°åÁä∂Ê≥ÅÁõ£Ë¶ñ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü\n„Éó„É≠„Çª„ÇπID: ${process.process_id}\nÁØÑÂõ≤: ID ${process.progress.start_id || '?'}-${process.progress.end_id || '?'}`);
                } else {
                    console.log('‚ùå „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„Çπ„Å™„Åó');
                    alert('ÁèæÂú®ÂÆüË°å‰∏≠„ÅÆHUGANJOBÁµ±ÂêàÈÄÅ‰ø°„Éó„É≠„Çª„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
            })
            .catch(error => {
                console.error('‚ùå ÊâãÂãï„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
                alert('ÈÄ≤Ë°åÁä∂Ê≥Å„ÉÅ„Çß„ÉÉ„ÇØ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
    }

    // IDÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    document.addEventListener('DOMContentLoaded', function() {
        const startIdField = document.getElementById('startId');
        const endIdField = document.getElementById('endId');

        if (startIdField) {
            startIdField.addEventListener('input', updateCommand);
        }
        if (endIdField) {
            endIdField.addEventListener('input', updateCommand);
        }

        // ÂàùÊúüË°®Á§∫ÊôÇ„Å´„Ç≥„Éû„É≥„Éâ„ÇíÊõ¥Êñ∞
        updateCommand();

        // üÜï „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Êó¢Â≠ò„ÅÆ„Éó„É≠„Çª„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        checkExistingProgress();
    });

    function checkExistingProgress() {
        console.log('üîç Êó¢Â≠ò„Éó„É≠„Çª„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...');

        // „Åæ„Åö„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„ÇπAPI„ÇíË©¶„Åô
        fetch('/api/huganjob/active_processes')
            .then(response => response.json())
            .then(data => {
                console.log('üìä „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„ÇπÂøúÁ≠î:', data);

                if (data.success && data.processes && data.processes.length > 0) {
                    console.log(`‚úÖ ${data.processes.length}ÂÄã„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„Çπ„ÇíÁô∫Ë¶ã`);

                    // ÊúÄÂàù„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„Çπ„ÅßÁõ£Ë¶ñÈñãÂßã
                    const process = data.processes[0];
                    console.log('üéØ Áõ£Ë¶ñÈñãÂßã„Éó„É≠„Çª„Çπ:', process.process_id);
                    startProgressMonitoring(process.process_id);
                } else {
                    console.log('üìù „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™HUGANJOB„Éó„É≠„Çª„Çπ„Å™„Åó');

                    // ‰ª£Êõø„Å®„Åó„Å¶„ÄÅ‰∏ÄËà¨ÁöÑ„Å™„Éó„É≠„Çª„ÇπAPI„ÇíË©¶„Åô
                    fetch('/api/get_active_processes')
                        .then(response => response.json())
                        .then(generalData => {
                            console.log('üìã ‰∏ÄËà¨„Éó„É≠„Çª„ÇπÂøúÁ≠î:', generalData);

                            if (generalData && Array.isArray(generalData)) {
                                const huganjobProcess = generalData.find(p =>
                                    p.command && p.command.includes('huganjob_unified_sender')
                                );

                                if (huganjobProcess) {
                                    console.log('üéØ ‰∏ÄËà¨„Éó„É≠„Çª„Çπ„Åã„ÇâÁô∫Ë¶ã:', huganjobProcess.id);
                                    startProgressMonitoring(huganjobProcess.id);
                                } else {
                                    console.log('‚ùå HUGANJOB„Éó„É≠„Çª„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('‰∏ÄËà¨„Éó„É≠„Çª„ÇπAPI „Ç®„É©„Éº:', error);
                        });
                }
            })
            .catch(error => {
                console.error('‚ùå „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É≠„Çª„ÇπAPI „Ç®„É©„Éº:', error);

                // „Ç®„É©„ÉºÊôÇ„ÇÇ‰∏ÄËà¨„Éó„É≠„Çª„ÇπAPI„ÇíË©¶„Åô
                fetch('/api/get_active_processes')
                    .then(response => response.json())
                    .then(generalData => {
                        console.log('üìã „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ - ‰∏ÄËà¨„Éó„É≠„Çª„ÇπÂøúÁ≠î:', generalData);

                        if (generalData && Array.isArray(generalData)) {
                            const huganjobProcess = generalData.find(p =>
                                p.command && p.command.includes('huganjob_unified_sender')
                            );

                            if (huganjobProcess) {
                                console.log('üéØ „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅßÁô∫Ë¶ã:', huganjobProcess.id);
                                startProgressMonitoring(huganjobProcess.id);
                            }
                        }
                    })
                    .catch(fallbackError => {
                        console.error('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØAPI „Ç®„É©„Éº:', fallbackError);
                    });
            });
    }





</script>
{% endblock %}
